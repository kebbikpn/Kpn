{% extends "base.html" %}

{% block title %}Join KPN{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-kpn-green text-white text-center">
                    <h3 class="mb-0">
                        <i class="fas fa-user-plus"></i> Join Kebbi Progressive Network
                    </h3>
                    <p class="mb-0">One Voice, One Change</p>
                </div>
                <div class="card-body p-4">
                    <form method="POST" enctype="multipart/form-data" id="registrationForm">
                        <!-- Personal Information -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="full_name" class="form-label">
                                    <i class="fas fa-user"></i> Full Name *
                                </label>
                                <input type="text" class="form-control" id="full_name" name="full_name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="username" class="form-label">
                                    <i class="fas fa-at"></i> Username *
                                </label>
                                <input type="text" class="form-control" id="username" name="username" required>
                                <small class="text-muted">This will be your login username</small>
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="email" class="form-label">
                                    <i class="fas fa-envelope"></i> Email Address *
                                </label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                            <div class="col-md-6">
                                <label for="phone" class="form-label">
                                    <i class="fas fa-phone"></i> Phone Number
                                </label>
                                <input type="tel" class="form-control" id="phone" name="phone">
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="password" class="form-label">
                                    <i class="fas fa-lock"></i> Password *
                                </label>
                                <input type="password" class="form-control" id="password" name="password" required>
                            </div>
                            <div class="col-md-6">
                                <label for="photo" class="form-label">
                                    <i class="fas fa-camera"></i> Profile Photo
                                </label>
                                <input type="file" class="form-control" id="photo" name="photo" accept="image/*">
                                <small class="text-muted">Recommended for ID tag generation</small>
                            </div>
                        </div>
                        
                        <!-- Location Selection -->
                        <div class="mt-4">
                            <h5 class="text-kpn-green">
                                <i class="fas fa-map-marker-alt"></i> Location Assignment
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="zone_id" class="form-label">Zone *</label>
                                    <select class="form-select" id="zone_id" name="zone_id" required onchange="loadLGAs()">
                                        <option value="">Select Zone</option>
                                        {% for zone in zones %}
                                        <option value="{{ zone.id }}">{{ zone.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="lga_id" class="form-label">LGA *</label>
                                    <select class="form-select" id="lga_id" name="lga_id" required onchange="loadWards()">
                                        <option value="">Select Zone first</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="ward_id" class="form-label">Ward *</label>
                                    <select class="form-select" id="ward_id" name="ward_id" required onchange="refreshPositions()">
                                        <option value="">Select LGA first</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Role Selection -->
                        <div class="mt-4">
                            <h5 class="text-kpn-green">
                                <i class="fas fa-user-tie"></i> Leadership Interest
                            </h5>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="role_type" id="general_member" 
                                       value="GENERAL_MEMBER" checked onchange="toggleRoleSelection()">
                                <label class="form-check-label" for="general_member">
                                    <strong>General Member</strong> - Support KPN activities and receive updates
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="role_type" id="leadership_role" 
                                       value="LEADERSHIP" onchange="toggleRoleSelection()">
                                <label class="form-check-label" for="leadership_role">
                                    <strong>Apply for Leadership Position</strong> - Take active role in KPN leadership
                                </label>
                            </div>
                            
                            <div id="leadership_options" class="mt-3" style="display: none;">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="role_level" class="form-label">Leadership Level</label>
                                        <select class="form-select" id="role_level" onchange="updateRoleOptions()">
                                            <option value="">Select Level</option>
                                            <option value="EXECUTIVE">State Executive (20 seats available)</option>
                                            <option value="ZONAL_COORDINATOR">Zonal Coordinator (3 per zone)</option>
                                            <option value="LGA_LEADER">LGA Leader (10 per LGA)</option>
                                            <option value="WARD_LEADER">Ward Leader (8 per ward)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="role_title" class="form-label">Specific Position</label>
                                        <select class="form-select" id="role_title" name="role_title">
                                            <option value="">Select level first</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bio -->
                        <div class="mt-4">
                            <label for="bio" class="form-label">
                                <i class="fas fa-info-circle"></i> Brief Biography (Optional)
                            </label>
                            <textarea class="form-control" id="bio" name="bio" rows="3" 
                                      placeholder="Tell us about yourself, your experience, and why you want to join KPN..."></textarea>
                        </div>
                        
                        <!-- Terms -->
                        <div class="mt-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agree_terms" required>
                                <label class="form-check-label" for="agree_terms">
                                    I agree to the <a href="{{ url_for('core.code_of_conduct') }}" target="_blank">KPN Code of Conduct</a> 
                                    and understand that I must follow the official Facebook page to complete registration.
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-kpn-primary btn-lg">
                                <i class="fas fa-user-plus"></i> Register with KPN
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Dynamic role options
const roleOptions = {
    'EXECUTIVE': [
        'State Coordinator', 'Deputy State Coordinator', 'General Secretary', 'Assistant General Secretary',
        'State Supervisor', 'Legal & Ethics Adviser', 'Treasurer', 'Financial Secretary',
        'Director of Mobilization', 'Assistant Director of Mobilization', 'Organizing Secretary',
        'Assistant Organizing Secretary', 'Auditor General', 'Welfare Officer',
        'Youth Development & Empowerment Officer', 'Women Leader', 'Assistant Women Leader',
        'Director of Media & Publicity', 'Assistant Director of Media & Publicity',
        'Public Relations & Community Engagement Officer'
    ],
    'ZONAL_COORDINATOR': ['Zonal Coordinator', 'Zonal Secretary', 'Zonal Publicity'],
    'LGA_LEADER': [
        'LGA Coordinator', 'Secretary', 'Organizing Secretary', 'Treasurer', 'Publicity',
        'LGA Supervisor', 'Women Leader', 'Welfare Officer', 'Director Contact and Mobilization', 'LGA Adviser'
    ],
    'WARD_LEADER': [
        'Ward Coordinator', 'Secretary', 'Organizing Secretary', 'Treasurer', 'Publicity',
        'Financial Secretary', 'Ward Supervisor', 'Ward Adviser'
    ]
};

function toggleRoleSelection() {
    const leadershipSelected = document.getElementById('leadership_role').checked;
    const leadershipOptions = document.getElementById('leadership_options');
    
    if (leadershipSelected) {
        leadershipOptions.style.display = 'block';
        // Remove the general member role type since we'll use hidden field for leadership
        document.getElementById('general_member').removeAttribute('name');
        document.getElementById('leadership_role').removeAttribute('name');
    } else {
        leadershipOptions.style.display = 'none';
        document.getElementById('role_level').value = '';
        document.getElementById('role_title').innerHTML = '<option value="">Select level first</option>';
        
        // Restore general member as the active role type
        document.getElementById('general_member').setAttribute('name', 'role_type');
        document.getElementById('leadership_role').removeAttribute('name');
        
        // Remove any existing hidden role_type field
        const existing = document.querySelector('input[name="role_type"][type="hidden"]');
        if (existing) existing.remove();
    }
}

function updateRoleOptions() {
    const level = document.getElementById('role_level').value;
    const roleTitle = document.getElementById('role_title');
    
    roleTitle.innerHTML = '<option value="">Loading available positions...</option>';
    
    if (level) {
        // Get current location selections
        const zoneId = document.getElementById('zone_id').value;
        const lgaId = document.getElementById('lga_id').value;
        const wardId = document.getElementById('ward_id').value;
        
        // Build query parameters
        const params = new URLSearchParams({
            role_level: level
        });
        
        if (zoneId) params.append('zone_id', zoneId);
        if (lgaId) params.append('lga_id', lgaId);
        if (wardId) params.append('ward_id', wardId);
        
        // Fetch available positions from API
        fetch(`/registration/api/available-positions?${params}`)
            .then(response => response.json())
            .then(data => {
                roleTitle.innerHTML = '<option value="">Select position</option>';
                
                if (data.available_positions && data.available_positions.length > 0) {
                    data.available_positions.forEach(position => {
                        const option = document.createElement('option');
                        option.value = position;
                        option.textContent = position;
                        roleTitle.appendChild(option);
                    });
                    
                    // Update seat availability info in the dropdown label
                    updateSeatInfo(level, data.seat_info);
                } else {
                    roleTitle.innerHTML = '<option value="">No positions available</option>';
                    updateSeatInfo(level, data.seat_info);
                }
            })
            .catch(error => {
                console.error('Error fetching available positions:', error);
                roleTitle.innerHTML = '<option value="">Error loading positions</option>';
            });
    } else {
        roleTitle.innerHTML = '<option value="">Select level first</option>';
    }
    
    // Update hidden role_type field for leadership roles
    const existing = document.querySelector('input[name="role_type"][type="hidden"]');
    if (existing) existing.remove();
    
    if (level) {
        const hiddenRoleType = document.createElement('input');
        hiddenRoleType.type = 'hidden';
        hiddenRoleType.name = 'role_type';
        hiddenRoleType.value = level;
        document.getElementById('registrationForm').appendChild(hiddenRoleType);
        
        // Ensure radio buttons don't interfere
        document.getElementById('general_member').removeAttribute('name');
        document.getElementById('leadership_role').removeAttribute('name');
    }
}

function updateSeatInfo(level, seatInfo) {
    const roleLevelSelect = document.getElementById('role_level');
    const levelText = level.replace('_', ' ').toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
    
    // Update the option text to show current availability
    if (seatInfo && roleLevelSelect) {
        const option = roleLevelSelect.querySelector(`option[value="${level}"]`);
        if (option) {
            const availableText = seatInfo.available > 0 
                ? `${seatInfo.available} seats available` 
                : 'No seats available';
            option.textContent = `${levelText} (${availableText})`;
        }
    }
}

function loadLGAs() {
    const zoneId = document.getElementById('zone_id').value;
    const lgaSelect = document.getElementById('lga_id');
    const wardSelect = document.getElementById('ward_id');
    
    lgaSelect.innerHTML = '<option value="">Loading...</option>';
    wardSelect.innerHTML = '<option value="">Select LGA first</option>';
    
    if (zoneId) {
        fetch(`/registration/api/lgas/${zoneId}`)
            .then(response => response.json())
            .then(lgas => {
                lgaSelect.innerHTML = '<option value="">Select LGA</option>';
                lgas.forEach(lga => {
                    const option = document.createElement('option');
                    option.value = lga.id;
                    option.textContent = lga.name;
                    lgaSelect.appendChild(option);
                });
                
                // Refresh available positions when zone changes
                const currentLevel = document.getElementById('role_level').value;
                if (currentLevel) {
                    updateRoleOptions();
                }
            });
    } else {
        lgaSelect.innerHTML = '<option value="">Select Zone first</option>';
    }
}

function loadWards() {
    const lgaId = document.getElementById('lga_id').value;
    const wardSelect = document.getElementById('ward_id');
    
    wardSelect.innerHTML = '<option value="">Loading...</option>';
    
    if (lgaId) {
        fetch(`/registration/api/wards/${lgaId}`)
            .then(response => response.json())
            .then(wards => {
                wardSelect.innerHTML = '<option value="">Select Ward</option>';
                wards.forEach(ward => {
                    const option = document.createElement('option');
                    option.value = ward.id;
                    option.textContent = ward.name;
                    wardSelect.appendChild(option);
                });
                
                // Refresh available positions when LGA changes
                const currentLevel = document.getElementById('role_level').value;
                if (currentLevel) {
                    updateRoleOptions();
                }
            });
    } else {
        wardSelect.innerHTML = '<option value="">Select LGA first</option>';
    }
}

function refreshPositions() {
    // Refresh available positions when ward changes
    const currentLevel = document.getElementById('role_level').value;
    if (currentLevel) {
        updateRoleOptions();
    }
}
</script>
{% endblock %}